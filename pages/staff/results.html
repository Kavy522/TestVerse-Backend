<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results — TestVerse</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/core/reset.css">
    <link rel="stylesheet" href="../../css/core/variables.css">
    <link rel="stylesheet" href="../../css/core/typography.css">
    <link rel="stylesheet" href="../../css/pages/staff/results.css">
</head>
<body>
<div class="dashboard-layout">

    <!-- ══ SIDEBAR ══ -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="dashboard.html" class="logo">
                <i class="fas fa-graduation-cap"></i><span>TestVerse</span>
            </a>
            <button class="sidebar-toggle" id="sidebarClose"><i class="fas fa-times"></i></button>
        </div>
        <nav class="sidebar-nav">
            <a href="dashboard.html"  class="nav-item"><i class="fas fa-home"></i><span>Dashboard</span></a>
            <a href="exams.html"      class="nav-item"><i class="fas fa-file-alt"></i><span>Exams</span></a>
            <a href="students.html"   class="nav-item"><i class="fas fa-users"></i><span>Students</span></a>
            <a href="results.html"    class="nav-item active"><i class="fas fa-chart-bar"></i><span>Results</span></a>
            <a href="analytics.html"  class="nav-item"><i class="fas fa-chart-line"></i><span>Analytics</span></a>
            <a href="settings.html"   class="nav-item"><i class="fas fa-cog"></i><span>Settings</span></a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-card">
                <img id="sidebarAvatar" src="" alt="" class="user-card-avatar">
                <div>
                    <span class="user-card-name" id="sidebarName">Staff</span>
                    <span class="user-card-role">Staff Member</span>
                </div>
            </div>
            <button class="nav-item logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i><span>Logout</span>
            </button>
        </div>
    </aside>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- ══ MAIN ══ -->
    <div class="main-content">
        <header class="topbar">
            <div class="topbar-left">
                <button class="mobile-menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
                <div class="breadcrumb">
                    <span class="breadcrumb-item">Staff</span>
                    <i class="fas fa-chevron-right breadcrumb-sep"></i>
                    <span class="breadcrumb-item active">Results</span>
                </div>
            </div>
            <div class="topbar-right">
                <div class="user-menu">
                    <img id="topbarAvatar" src="" alt="" class="user-avatar">
                    <div class="user-info">
                        <div class="user-name" id="topbarName">Staff</div>
                        <div class="user-role">Staff Member</div>
                    </div>
                </div>
            </div>
        </header>

        <main class="page-content">
            <div id="alertContainer"></div>

            <!-- ── PAGE HEADER ── -->
            <div class="page-header">
                <div class="page-header-left">
                    <h1 class="page-title"><i class="fas fa-chart-bar"></i> Results</h1>
                    <p class="page-subtitle">Review, grade and publish exam results</p>
                </div>
            </div>

            <!-- ── EXAM FILTER TABS ── -->
            <div class="section-card">
                <div class="section-card-header">
                    <h2 class="section-title"><i class="fas fa-file-alt"></i> Select Exam</h2>
                    <div class="filter-tabs" id="examStatusTabs">
                        <button class="filter-tab active" data-status="completed">Completed</button>
                        <button class="filter-tab" data-status="all">All Exams</button>
                    </div>
                </div>

                <!-- Exam list loading -->
                <div class="inline-loading" id="examListLoading">
                    <div class="spinner-sm"></div><span>Loading exams…</span>
                </div>

                <!-- Exam grid -->
                <div class="exam-grid" id="examGrid" style="display:none;"></div>

                <!-- Exam empty -->
                <div class="inline-empty" id="examListEmpty" style="display:none;">
                    <i class="fas fa-inbox"></i>
                    <p>No completed exams found.</p>
                </div>
            </div>

            <!-- ── RESULTS PANEL (shown after exam selected) ── -->
            <div class="results-panel" id="resultsPanel" style="display:none;">

                <!-- Results Panel Header -->
                <div class="results-panel-header">
                    <div class="results-panel-header-left">
                        <button class="back-btn" id="backToExams">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <div class="selected-exam-info">
                            <span class="selected-exam-title" id="selectedExamTitle">Exam Title</span>
                            <span class="selected-exam-meta" id="selectedExamMeta"></span>
                        </div>
                    </div>
                    <div class="results-panel-header-right">
                        <!-- Publish All Button — locked until all graded -->
                        <div class="publish-all-wrap" id="publishAllWrap">
                            <button class="btn btn-publish" id="publishAllBtn" disabled>
                                <i class="fas fa-lock"></i>
                                <span class="btn-text">Publish All Results</span>
                                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                            </button>
                            <span class="publish-hint" id="publishHint">Grade all submissions first</span>
                        </div>
                    </div>
                </div>

                <!-- Results Stats Bar -->
                <div class="results-stats" id="resultsStats">
                    <div class="rstat">
                        <div class="rstat-icon blue"><i class="fas fa-users"></i></div>
                        <div class="rstat-body">
                            <span class="rstat-val" id="rstatTotal">0</span>
                            <span class="rstat-lbl">Total</span>
                        </div>
                    </div>
                    <div class="rstat">
                        <div class="rstat-icon green"><i class="fas fa-check-circle"></i></div>
                        <div class="rstat-body">
                            <span class="rstat-val" id="rstatGraded">0</span>
                            <span class="rstat-lbl">Fully Graded</span>
                        </div>
                    </div>
                    <div class="rstat">
                        <div class="rstat-icon amber"><i class="fas fa-clock"></i></div>
                        <div class="rstat-body">
                            <span class="rstat-val" id="rstatPending">0</span>
                            <span class="rstat-lbl">Pending Review</span>
                        </div>
                    </div>
                    <div class="rstat">
                        <div class="rstat-icon purple"><i class="fas fa-paper-plane"></i></div>
                        <div class="rstat-body">
                            <span class="rstat-val" id="rstatPublished">0</span>
                            <span class="rstat-lbl">Published</span>
                        </div>
                    </div>
                    <div class="rstat">
                        <div class="rstat-icon indigo"><i class="fas fa-percentage"></i></div>
                        <div class="rstat-body">
                            <span class="rstat-val" id="rstatAvg">—</span>
                            <span class="rstat-lbl">Avg Score</span>
                        </div>
                    </div>
                </div>

                <!-- Results Toolbar -->
                <div class="results-toolbar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="resultSearch" placeholder="Search student name, email…" autocomplete="off">
                        <button class="search-clear" id="resultSearchClear" style="display:none;"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="toolbar-filters">
                        <select class="toolbar-select" id="gradingFilter">
                            <option value="">All Statuses</option>
                            <option value="fully_graded">Fully Graded</option>
                            <option value="partially_graded">Partially Graded</option>
                            <option value="pending">Pending</option>
                        </select>
                        <select class="toolbar-select" id="publishFilter">
                            <option value="">All</option>
                            <option value="published">Published</option>
                            <option value="unpublished">Unpublished</option>
                        </select>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="table-wrap">
                    <div class="table-loading" id="resultsLoading">
                        <div class="spinner"></div><p>Loading results…</p>
                    </div>
                    <div class="table-empty" id="resultsEmpty" style="display:none;">
                        <div class="empty-icon"><i class="fas fa-inbox"></i></div>
                        <h3>No results found</h3>
                        <p>No students have submitted this exam yet.</p>
                    </div>
                    <table class="results-table" id="resultsTable" style="display:none;">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Marks</th>
                                <th>Percentage</th>
                                <th>Status</th>
                                <th>Grading</th>
                                <th>Published</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody"></tbody>
                    </table>
                </div>

            </div><!-- /results-panel -->

        </main>
    </div>
</div>

<!-- ══ GRADE DRAWER ══ -->
<div class="drawer-backdrop" id="gradeDrawerBackdrop"></div>
<aside class="grade-drawer" id="gradeDrawer">
    <div class="drawer-header">
        <div class="drawer-header-left">
            <div class="drawer-icon"><i class="fas fa-pen-nib"></i></div>
            <div>
                <h2 class="drawer-title" id="gradeDrawerTitle">Review &amp; Grade</h2>
                <p  class="drawer-subtitle" id="gradeDrawerSubtitle">Score descriptive &amp; coding answers</p>
            </div>
        </div>
        <button class="drawer-close" id="gradeDrawerClose"><i class="fas fa-times"></i></button>
    </div>

    <div class="drawer-fetch-loading" id="gradeDrawerLoading">
        <div class="spinner"></div><p>Loading answers…</p>
    </div>

    <div class="grade-drawer-body" id="gradeDrawerBody" style="display:none;">
        <div id="gradeDrawerAlert"></div>

        <!-- Student identity -->
        <div class="grade-student-card" id="gradeStudentCard">
            <img class="grade-student-avatar" id="gradeStudentAvatar" src="" alt="">
            <div class="grade-student-info">
                <span class="grade-student-name"  id="gradeStudentName">—</span>
                <span class="grade-student-email" id="gradeStudentEmail">—</span>
            </div>
            <div class="grade-student-score">
                <span class="score-current" id="gradeScoreCurrent">—</span>
                <span class="score-sep">/</span>
                <span class="score-total"   id="gradeScoreTotal">—</span>
            </div>
        </div>

        <!-- MCQ Auto-graded summary -->
        <div class="mcq-summary" id="mcqSummary" style="display:none;">
            <div class="mcq-summary-icon"><i class="fas fa-robot"></i></div>
            <div class="mcq-summary-text">
                <strong>MCQ auto-graded:</strong>
                <span id="mcqSummaryText">0 correct / 0 total</span>
            </div>
            <button class="btn btn-sm btn-outline" id="autoGradeMcqBtn" style="margin-left:auto;">
                <span class="btn-text"><i class="fas fa-magic"></i> Auto Grade All MCQs</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
        </div>

        <!-- Questions list -->
        <div id="questionsContainer"></div>

        <!-- Save all button -->
        <div class="grade-save-all">
            <button class="btn btn-primary btn-full" id="saveAllGradesBtn">
                <span class="btn-text"><i class="fas fa-save"></i> Save All Grades</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i> Saving…</span>
            </button>
        </div>
    </div>
</aside>

<!-- ══ PUBLISH CONFIRM MODAL ══ -->
<div class="modal" id="publishModal">
    <div class="modal-dialog modal-sm">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-paper-plane"></i> Publish Results</h2>
            <button class="modal-close" id="publishModalClose"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="info-box" id="publishModalBody">
                <i class="fas fa-info-circle"></i>
                <p>All <strong id="publishCount">0</strong> graded results will be visible to students. This cannot be undone.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline"  id="publishModalCancel">Cancel</button>
            <button class="btn btn-publish"  id="publishModalConfirm">
                <span class="btn-text"><i class="fas fa-paper-plane"></i> Confirm Publish</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
        </div>
    </div>
</div>

<script src="../../js/config.js"></script>
<script src="../../js/api.js"></script>
<script src="../../js/auth.js"></script>
<script src="../../js/ui.js"></script>
<script src="../../js/pages/staff/results.js"></script>
</body>
</html>